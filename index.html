<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบนับเวลาพร้อมกันหลายคน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/dist/html5-qrcode.min.js" type="text/javascript"></script>
    <!-- Tesseract.js for OCR -->
    <script src='https://unpkg.com/tesseract.js@5.0.0/dist/tesseract.min.js'></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Style for the scrollbar */
        #userListContainer::-webkit-scrollbar,
        #historyContainer::-webkit-scrollbar,
        #activeTimersContainer::-webkit-scrollbar,
        .admin-history-container::-webkit-scrollbar {
            width: 8px;
        }
        #userListContainer::-webkit-scrollbar-track,
        #historyContainer::-webkit-scrollbar-track,
        #activeTimersContainer::-webkit-scrollbar-track,
        .admin-history-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #userListContainer::-webkit-scrollbar-thumb,
        #historyContainer::-webkit-scrollbar-thumb,
        #activeTimersContainer::-webkit-scrollbar-thumb,
        .admin-history-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #userListContainer::-webkit-scrollbar-thumb:hover,
        #historyContainer::-webkit-scrollbar-thumb:hover,
        #activeTimersContainer::-webkit-scrollbar-thumb:hover,
        .admin-history-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .timer-card {
            transition: all 0.3s ease;
        }
        .input-error {
            border-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.4);
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        #reader video {
            width: 100% !important;
            height: auto !important;
            border-radius: 0.5rem;
        }
        /* OCR Styles */
        #ocr-video-container {
            position: relative;
            width: 100%;
        }
        #ocr-scan-box {
            position: absolute;
            border: 3px dashed rgba(255, 255, 255, 0.7);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            top: 50%;
            left: 50%;
            width: 90%;
            height: 30%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        .ocr-loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-gray-200 flex items-center justify-center z-50">
        <div class="w-full max-w-sm p-8 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">เข้าสู่ระบบ</h1>
            <div class="space-y-4">
                <div>
                    <label for="usernameInput" class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้</label>
                    <input type="text" id="usernameInput" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                </div>
                <div>
                    <label for="passwordInput" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="passwordInput" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                </div>
                <p id="loginError" class="text-red-500 text-center text-sm hidden">ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง</p>
                <button id="loginBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-md hover:bg-indigo-700 transition text-lg">
                    เข้าสู่ระบบ
                </button>
            </div>
        </div>
    </div>

    <!-- User App Container -->
    <div id="appContainer" class="w-full max-w-screen-2xl mx-auto grid lg:grid-cols-5 gap-8 hidden">
        
        <!-- Column 1: Controls -->
        <div id="controlsColumn" class="bg-white p-6 rounded-xl shadow-lg flex flex-col lg:col-span-1">
             <div class="mb-4">
                 <div class="flex justify-between items-center">
                     <div class="flex items-center gap-2">
                         <h2 class="text-xl font-bold text-gray-800">ผู้ใช้งาน</h2>
                         <div id="connectionStatus" class="w-3 h-3 bg-gray-400 rounded-full" title="กำลังเชื่อมต่อ..."></div>
                     </div>
                     <button id="logoutBtn" class="text-xs bg-gray-200 text-gray-600 font-bold py-1 px-3 rounded-md hover:bg-gray-300 transition">
                         ออกจากระบบ
                     </button>
                 </div>
                 <p class="text-indigo-600 font-bold" id="loggedInUserDisplay"></p>
             </div>
            
             <div id="userControls">
                 <div class="bg-gray-100 p-2 rounded-lg mb-4">
                     <label class="block text-xs font-medium text-gray-700 mb-1">ตั้งค่าเวลาเริ่มต้น</label>
                     <div class="grid grid-cols-3 gap-1">
                         <input type="number" id="hoursInput" placeholder="ชม." class="w-full p-1 border rounded-md text-center text-sm" min="0">
                         <input type="number" id="minutesInput" placeholder="น." class="w-full p-1 border rounded-md text-center text-sm" min="0" max="59">
                         <input type="number" id="secondsInput" placeholder="ว." class="w-full p-1 border rounded-md text-center text-sm" min="0" max="59">
                     </div>
                     <button id="setDefaultTimeBtn" class="w-full mt-2 bg-green-600 text-white font-bold py-1 px-2 rounded-md hover:bg-green-700 transition text-sm">
                         ตั้งค่าเวลา
                     </button>
                 </div>
                
                 <div class="relative">
                     <div class="flex items-center gap-2 mb-4">
                         <input type="text" id="idInput" class="block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base transition" placeholder="ยิงบาร์โค้ด หรือ ค้นหา..." autocomplete="off">
                         <button id="ocrScanBtn" title="สแกนตัวเลขด้วยกล้อง" class="p-2.5 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                         </button>
                         <button id="scanBtn" title="สแกนบาร์โค้ด" class="p-2.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm10.5 4a.5.5 0 00-.5-.5h-3a.5.5 0 000 1h3a.5.5 0 00.5-.5zM4 8a.5.5 0 01.5-.5h11a.5.5 0 010 1h-11A.5.5 0 014 8zm0 2a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5A.5.5 0 014 10zm11.5 2.5a.5.5 0 00-.5-.5h-3a.5.5 0 000 1h3a.5.5 0 00.5-.5zM4 14a.5.5 0 01.5-.5h11a.5.5 0 010 1h-11a.5.5 0 01-.5-.5z" clip-rule="evenodd" /></svg>
                         </button>
                     </div>
                     <div id="userListContainer" class="absolute z-20 w-full -mt-4 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-80 overflow-y-auto">
                          <div id="listStatus" class="p-4 text-center"></div>
                          <ul id="userList" class="space-y-1 p-1"></ul>
                     </div>
                 </div>
                 <button id="resetAllBtn" class="w-full mt-4 bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition">
                     รีเซ็ตข้อมูลทั้งหมด
                 </button>
             </div>
        </div>

        <!-- Column 2: Active Timers -->
        <div class="bg-white p-8 rounded-xl shadow-lg flex flex-col lg:col-span-2">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">ระบบนับเวลา</h1>
            <p class="text-center text-gray-500 mb-6" id="statusText">กรุณายิงบาร์โค้ดเพื่อเริ่ม</p>
            
            <div id="activeTimersContainer" class="flex-grow bg-gray-50 rounded-lg p-4 space-y-4 overflow-y-auto h-full min-h-[30rem]">
                <div id="timerPlaceholder" class="text-center text-gray-400 flex items-center justify-center h-full">
                    <p>ยิงบาร์โค้ดเพื่อเริ่มนับเวลา...</p>
                </div>
            </div>
        </div>

        <!-- Column 3: History -->
        <div class="bg-white p-8 rounded-xl shadow-lg flex flex-col lg:col-span-2">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">ประวัติ (จากรอบล่าสุด)</h2>
            <div id="historyContainer" class="flex-grow overflow-y-auto border rounded-lg min-h-[30rem]">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-3">#</th>
                            <th scope="col" class="px-6 py-3">ชื่อ-สกุล</th>
                            <th scope="col" class="px-6 py-3">เวลาตั้งค่า</th>
                            <th scope="col" class="px-6 py-3">เวลาที่ครบกำหนด</th>
                            <th scope="col" class="px-6 py-3">ผลการตรวจ</th>
                            <th scope="col" class="px-6 py-3"><span class="sr-only">ลบ</span></th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                       <tr class="bg-white border-b"><td colspan="6" class="px-6 py-4 text-center">ยังไม่มีประวัติ</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin View -->
    <div id="adminContainer" class="w-full max-w-screen-2xl mx-auto hidden">
        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-lg mb-8">
             <div>
                 <div class="flex items-center gap-3">
                     <h1 class="text-2xl font-bold text-gray-800">มุมมองผู้ดูแลระบบ - ประวัติทั้งหมด</h1>
                     <div id="adminConnectionStatus" class="w-3 h-3 bg-gray-400 rounded-full" title="กำลังเชื่อมต่อ..."></div>
                 </div>
                 <p class="text-indigo-600 font-bold" id="adminLoggedInUserDisplay"></p>
             </div>
             <div class="flex items-center gap-4">
                 <button id="masterResetBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition">
                     รีเซ็ตระบบทั้งหมด
                 </button>
                 <button id="downloadExcelBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition">
                      ดาวน์โหลด Excel
                 </button>
                 <button id="adminLogoutBtn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 transition">
                     ออกจากระบบ
                 </button>
             </div>
        </div>
        <div id="adminGrid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
            <!-- Admin columns will be generated here -->
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scannerModal" class="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-4 rounded-lg shadow-xl w-full max-w-md">
            <p class="text-center text-gray-600 mb-2">วางบาร์โค้ดในกรอบสี่เหลี่ยม</p>
            <div class="relative w-full aspect-square bg-gray-200 rounded-lg overflow-hidden">
                <div id="reader-loading" class="absolute inset-0 flex items-center justify-center">
                    <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                 <div id="reader" class="w-full"></div>
            </div>
            <button id="closeScannerBtn" class="w-full mt-4 bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700">
                ปิดกล้อง
            </button>
        </div>
    </div>
    
    <!-- OCR Scanner Modal -->
    <div id="ocrScannerModal" class="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-4 rounded-lg shadow-xl w-full max-w-lg text-center">
            <p class="text-center text-gray-600 mb-2">วางตัวเลขในกรอบสี่เหลี่ยม</p>
            <div id="ocr-video-container" class="mb-4 bg-gray-900 rounded-lg overflow-hidden shadow-inner">
                <video id="ocr-video" autoplay playsinline class="w-full h-auto"></video>
                <div id="ocr-scan-box"></div>
            </div>
            <div id="ocr-status" class="text-gray-700 h-8 flex items-center justify-center w-full mb-2">
                 <p>กำลังเตรียมกล้อง...</p>
            </div>
            <div class="flex gap-4">
                 <button id="ocrCaptureBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400">
                     สแกน
                 </button>
                 <button id="closeOcrScannerBtn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700">
                     ปิดกล้อง
                 </button>
            </div>
        </div>
    </div>


    <!-- Notification Modal -->
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h3 id="notificationTitle" class="text-lg font-bold text-gray-800 mb-2"></h3>
            <p id="notificationMessage" class="text-gray-600 mb-4"></p>
            <button id="notificationCloseBtn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-md hover:bg-indigo-700">
                ตกลง
            </button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // VVVVVVVV  วาง URL ของ Web App ที่คุณสร้างจาก Google Apps Script ตรงนี้ VVVVVVVV
        const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbxElRMDT970Oxso1TL2dMeQLuUJDliRIEHE0xaRtcQa8XyWJbHhz1DRtHi9o-OXeCCW/exec';
        // ^^^^^^^^  วาง URL ของ Web App ที่คุณสร้างจาก Google Apps Script ตรงนี้ ^^^^^^^^
        
        // --- User Credentials ---
        const USER_CREDENTIALS = {
            "user1": "pass1", "user2": "pass2", "user3": "pass3", "user4": "pass4", "user5": "pass5",
            "admin": "adminpass"
        };
        const REGULAR_USERS = ["user1", "user2", "user3", "user4", "user5"];

        // Login Elements
        const loginScreen = document.getElementById('loginScreen');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');

        // Main Page Elements
        const idInput = document.getElementById('idInput');
        const statusText = document.getElementById('statusText');
        const userList = document.getElementById('userList');
        const userListContainer = document.getElementById('userListContainer');
        const listStatus = document.getElementById('listStatus');
        const activeTimersContainer = document.getElementById('activeTimersContainer');
        const setDefaultTimeBtn = document.getElementById('setDefaultTimeBtn');
        const hoursInput = document.getElementById('hoursInput');
        const minutesInput = document.getElementById('minutesInput');
        const secondsInput = document.getElementById('secondsInput');
        let timerPlaceholder = document.getElementById('timerPlaceholder');
        const resetAllBtn = document.getElementById('resetAllBtn');
        const historyBody = document.getElementById('historyBody');
        const appContainer = document.getElementById('appContainer');
        const adminContainer = document.getElementById('adminContainer');
        const loggedInUserDisplay = document.getElementById('loggedInUserDisplay');
        const adminLoggedInUserDisplay = document.getElementById('adminLoggedInUserDisplay');
        const connectionStatus = document.getElementById('connectionStatus');
        const adminConnectionStatus = document.getElementById('adminConnectionStatus');
        
        // Scanner Elements
        const scanBtn = document.getElementById('scanBtn');
        const scannerModal = document.getElementById('scannerModal');
        const closeScannerBtn = document.getElementById('closeScannerBtn');
        let html5Qrcode;

        // OCR Elements
        const ocrScanBtn = document.getElementById('ocrScanBtn');
        const ocrScannerModal = document.getElementById('ocrScannerModal');
        const ocrVideo = document.getElementById('ocr-video');
        const ocrCaptureBtn = document.getElementById('ocrCaptureBtn');
        const closeOcrScannerBtn = document.getElementById('closeOcrScannerBtn');
        const ocrStatusEl = document.getElementById('ocr-status');
        let tesseractWorker = null;
        let isOcrCameraReady = false;
        
        // Admin Elements
        const masterResetBtn = document.getElementById('masterResetBtn');

        // Notification Modal Elements
        const notificationModal = document.getElementById('notificationModal');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationCloseBtn = document.getElementById('notificationCloseBtn');


        // App State
        let globalAnimationFrameId = null;
        let allUsers = [];
        let activeTimers = [];
        let historyData = [];
        let sessionDefaultTimeInSeconds = null;
        let userSnapshots = {};
        let globalState = {}; // Contains lockedIds and completedIds
        let isInitialLoadComplete = false; // Flag to prevent premature state saving

        // Sound Synthesizers
        let successSynth, errorSynth;

        // Firebase State
        let db;
        let unsubscribeListeners = [];
        // Use __app_id provided by the environment, with a fallback from the hardcoded config.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        async function initializeFirebase(firebaseConfig, loggedInUser, isAdmin) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Authenticated with Firebase UID:", user.uid);
                        // Fetch data from Google Sheets first
                        await fetchData();

                        // Now that we are authenticated and have sheet data, set up Firestore listeners
                        if (isAdmin) {
                            setupAdminListeners();
                        } else {
                            const globalStateDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'countdownData', 'globalState');
                            setupGlobalStateListener(globalStateDocRef);
                            const appDataDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'countdownData', loggedInUser);
                            setupSnapshotListener(appDataDocRef);
                        }
                    }
                });

                if (!auth.currentUser) {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) {
                        await signInWithCustomToken(auth, token);
                    } else {
                        await signInAnonymously(auth);
                    }
                }

            } catch(error) {
                console.error("Firebase Initialization Error:", error);
                let errorTitle = "เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล";
                let errorMessage = `<p class="text-sm text-gray-700 mb-4">ไม่สามารถเริ่มต้นการเชื่อมต่อกับฐานข้อมูลได้ กรุณาตรวจสอบว่า Firebase Config ถูกต้อง</p>`;
                if (error.code) { 
                    errorTitle = `เกิดข้อผิดพลาด: ${error.code}`;
                    errorMessage = `<p class="text-sm text-gray-700 mb-4">${error.message}</p>`;
                }
                
                const container = sessionStorage.getItem('isAdmin') === 'true' ? adminContainer : appContainer;
                container.innerHTML = `<div class="col-span-full text-center bg-white p-8 rounded-xl shadow-lg"><h2 class="text-2xl font-bold text-red-600 mb-4">${errorTitle}</h2>${errorMessage}<button onclick="window.location.reload();" class="mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition">รีเฟรช</button></div>`;
                container.classList.remove('hidden');
                loginScreen.classList.add('hidden');
            }
        }

        async function main() {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            const isAdmin = sessionStorage.getItem('isAdmin') === 'true';

            if (!isAdmin) {
                idInput.focus();
                document.body.addEventListener('click', () => initializeAudio(), { once: true });
                document.body.addEventListener('keydown', () => initializeAudio(), { once: true });
                initializeOCR(); // Prepare OCR in the background
            }

            // Use __firebase_config if available, otherwise use hardcoded fallback.
            const firebaseConfig = typeof __firebase_config !== 'undefined'
                ? JSON.parse(__firebase_config)
                : { // Fallback config for local testing
                    apiKey: "AIzaSyC4KDnkJ_3Md1hHqr3pu5IxbDuSwUz7-vY",
                    authDomain: "coerf-a033d.firebaseapp.com",
                    projectId: "coerf-a033d",
                    storageBucket: "coerf-a033d.appspot.com",
                    messagingSenderId: "1004453397450",
                    appId: "1:1004453397450:web:83825d12550e8ecf940533",
                    measurementId: "G-TBKV4XWWM7"
                };

            if (!firebaseConfig || !firebaseConfig.apiKey) {
                 const container = isAdmin ? adminContainer : appContainer;
                 container.innerHTML = `<div class="col-span-full text-center bg-white p-8 rounded-xl shadow-lg"><h2 class="text-2xl font-bold text-red-600 mb-4">ข้อผิดพลาดร้ายแรง</h2><p class="text-sm text-gray-700 mb-4">ไม่พบข้อมูลการกำหนดค่า Firebase (__firebase_config)</p></div>`;
                 container.classList.remove('hidden');
                 loginScreen.classList.add('hidden');
                 return;
            }
            
            await initializeFirebase(firebaseConfig, loggedInUser, isAdmin);
        }

        async function fetchData() {
            if (sessionStorage.getItem('isAdmin') !== 'true') {
                idInput.disabled = true;
                idInput.placeholder = "กำลังโหลดข้อมูล...";
                listStatus.innerHTML = '<p class="text-gray-500">กำลังโหลดข้อมูล...</p>';
                listStatus.classList.remove('hidden');
                userList.classList.add('hidden');
            }

            try {
                const response = await fetch(`${appsScriptUrl}?cachebust=${Date.now()}`);
                if (!response.ok) throw new Error(`ไม่สามารถเชื่อมต่อกับ Apps Script ได้: ${response.status} ${response.statusText}`);
                const data = await response.json();
                if (data.status === 'error') throw new Error(`Apps Script Error: ${data.message}`);
                allUsers = data;
                if (allUsers.length === 0) throw new Error('ไม่พบข้อมูลใน Google Sheet หรือไฟล์อาจจะว่างเปล่า');

                if (sessionStorage.getItem('isAdmin') !== 'true') {
                    idInput.disabled = false;
                    idInput.placeholder = "ยิงบาร์โค้ด หรือ ค้นหา...";
                    listStatus.classList.add('hidden');
                    userList.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Failed to load user list:', error);
                if (sessionStorage.getItem('isAdmin') !== 'true') {
                    idInput.placeholder = "ไม่สามารถโหลดรายชื่อได้";
                    listStatus.innerHTML = `<div class="text-left"><p class="text-red-600 font-bold mb-2">เกิดข้อผิดพลาดในการโหลดข้อมูล</p><p class="text-sm text-gray-700 mb-4">${error.message}</p></div><button id="reloadBtn" class="mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition">ลองอีกครั้ง</button>`;
                    listStatus.classList.remove('hidden');
                    document.getElementById('reloadBtn').addEventListener('click', fetchData);
                }
            }
        }
        
        function setupGlobalStateListener(docRef) {
            onSnapshot(docRef, (docSnap) => {
                globalState = docSnap.exists() ? docSnap.data() : { lockedIds: {}, completedIds: {} };
                renderUserList(idInput.value.trim()); 
            }, (error) => {
                 console.error("Global state snapshot error:", error);
                 if (connectionStatus) {
                    connectionStatus.classList.remove('bg-gray-400', 'bg-green-500');
                    connectionStatus.classList.add('bg-red-500');
                    connectionStatus.title = 'การเชื่อมต่อขัดข้อง';
                }
            });
        }

        function setupSnapshotListener(docRef) {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (connectionStatus) {
                    connectionStatus.classList.remove('bg-gray-400', 'bg-red-500');
                    connectionStatus.classList.add('bg-green-500');
                    connectionStatus.title = 'เชื่อมต่อเรียลไทม์';
                }
                const data = docSnap.exists() ? docSnap.data() : {};
                updateLocalState(data);
                renderUI();
                isInitialLoadComplete = true; 
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                statusText.textContent = "การเชื่อมต่อข้อมูลขัดข้อง";
                if (connectionStatus) {
                    connectionStatus.classList.remove('bg-gray-400', 'bg-green-500');
                    connectionStatus.classList.add('bg-red-500');
                    connectionStatus.title = 'การเชื่อมต่อขัดข้อง';
                }
            });
            unsubscribeListeners.push(unsubscribe);
        }

        function setupAdminListeners() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            const adminGrid = document.getElementById('adminGrid');
            adminGrid.innerHTML = ''; 

            REGULAR_USERS.forEach(user => {
                const userColumn = document.createElement('div');
                userColumn.className = 'bg-white p-4 rounded-xl shadow-lg flex flex-col';
                userColumn.innerHTML = `
                    <h2 class="text-lg font-bold text-center mb-4 text-indigo-600">${user}</h2>
                    <div class="flex-grow overflow-y-auto border rounded-lg h-[70vh] admin-history-container">
                        <table class="w-full text-xs text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-2 py-2">#</th>
                                    <th scope="col" class="px-2 py-2">ชื่อ-สกุล</th>
                                    <th scope="col" class="px-2 py-2">ผลการตรวจ</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody-${user}">
                                <tr><td colspan="3" class="p-4 text-center text-gray-400">กำลังโหลด...</td></tr>
                            </tbody>
                        </table>
                    </div>
                `;
                adminGrid.appendChild(userColumn);
            });

            REGULAR_USERS.forEach((username, index) => {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'countdownData', username);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (index === 0 && adminConnectionStatus) {
                        adminConnectionStatus.classList.remove('bg-gray-400', 'bg-red-500');
                        adminConnectionStatus.classList.add('bg-green-500');
                        adminConnectionStatus.title = 'เชื่อมต่อเรียลไทม์';
                    }
                    const userData = docSnap.exists() ? docSnap.data() : {};
                    userSnapshots[username] = userData;
                    const historyData = userData.timerHistory || [];
                    const tbody = document.getElementById(`historyBody-${username}`);
                    if (tbody) {
                        renderAdminHistoryForUser(tbody, historyData);
                    }
                }, (error) => {
                     console.error(`Firestore snapshot error for ${username}:`, error);
                     if (adminConnectionStatus) {
                        adminConnectionStatus.classList.remove('bg-gray-400', 'bg-green-500');
                        adminConnectionStatus.classList.add('bg-red-500');
                        adminConnectionStatus.title = 'การเชื่อมต่อขัดข้อง';
                     }
                });
                unsubscribeListeners.push(unsubscribe);
            });
        }
        
        function renderAdminHistoryForUser(tbody, data) {
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-400">ไม่มีประวัติ</td></tr>`;
                return;
            }
            data.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';

                let statusHtml = `<span class="bg-gray-100 text-gray-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${entry.status}</span>`;
                if (entry.status === 'ผลบวก (+)' || entry.status === 'ผลลบ (-)') {
                    statusHtml = `<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${entry.status}</span>`;
                } else if (entry.status === 'รอผล') {
                    statusHtml = `<span class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${entry.status}</span>`;
                }


                row.innerHTML = `
                    <td class="px-2 py-2 font-medium text-gray-900">${data.length - index}</td>
                    <td class="px-2 py-2">${entry.user.fullName}<br><span class="text-xs text-gray-400">ID: ${entry.user.id} / HN: ${entry.user.hn || '-'}</span></td>
                    <td class="px-2 py-2">${statusHtml}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateLocalState(data) {
            activeTimers.forEach(t => {
                const card = document.getElementById(`timer-${t.user.id}`);
                if (card) card.remove();
            });
            activeTimers = [];
            historyData = data.timerHistory || [];

            const savedTimers = data.activeTimers || [];
            savedTimers.forEach(savedTimer => {
                const user = allUsers.find(u => u.id === savedTimer.id);
                if (user) {
                     const timeLeftMs = savedTimer.endTime - Date.now();
                     const timerData = { user, startTime: Date.now() - (savedTimer.duration - timeLeftMs), duration: savedTimer.duration, owner: savedTimer.owner, finished: timeLeftMs <= 0, completionTime: savedTimer.completionTime };
                     activeTimers.push(timerData);
                }
            });
        }
        
        function renderUI() {
             const timerPlaceholderEl = document.getElementById('timerPlaceholder');
             if (timerPlaceholderEl && activeTimers.length > 0) {
                 timerPlaceholderEl.remove();
             } else if (!timerPlaceholderEl && activeTimers.length === 0) {
                 activeTimersContainer.innerHTML = '<div id="timerPlaceholder" class="text-center text-gray-400 flex items-center justify-center h-full"><p>ยิงบาร์โค้ดเพื่อเริ่มนับเวลา...</p></div>';
             }
             
             activeTimers.forEach(timer => {
                 if(!document.getElementById(`timer-${timer.user.id}`)) {
                  createTimerCard(timer.user, timer.owner, timer.completionTime);
                 }
             });

             if (activeTimers.length > 0) startGlobalAnimationLoop();
             renderHistory();
             renderUserList(idInput.value.trim());
        }
        
        function initializeAudio() {
            if (Tone.context.state !== 'running') Tone.context.resume();
            if (!successSynth) successSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
            if (!errorSynth) errorSynth = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.005, decay: 0.2, sustain: 0.1, release: 1 } }).toDestination();
        }

        window.onload = function() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                loginScreen.classList.add('hidden');
                const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                const loggedInUser = sessionStorage.getItem('loggedInUser');
                const container = isAdmin ? adminContainer : appContainer;
                
                if (isAdmin) {
                    adminLoggedInUserDisplay.textContent = `ผู้ใช้: ${loggedInUser}`;
                } else {
                    loggedInUserDisplay.textContent = `ผู้ใช้: ${loggedInUser}`;
                }

                container.classList.remove('hidden');
                main();
            } else {
                usernameInput.focus();
            }
        };
        
        function renderUserList(filter = '') {
            userList.innerHTML = '';

            if (!filter) {
                userListContainer.classList.add('hidden');
                return;
            }

            const lowerCaseFilter = filter.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.fullName.toLowerCase().includes(lowerCaseFilter) || 
                user.id.includes(filter) || 
                (user.hn && user.hn.includes(filter))
            );
            
            if (filteredUsers.length === 0) {
                 userList.innerHTML = `<li class="p-3 text-gray-500 text-center cursor-default">ไม่พบรายชื่อที่ตรงกัน</li>`;
                 userListContainer.classList.remove('hidden');
                 return;
            }

            filteredUsers.forEach(user => {
                const li = document.createElement('li');
                li.dataset.id = user.id;
                let content = `<span class="font-bold block">${user.fullName}</span><span class="text-sm text-gray-500">ID: ${user.id} / HN: ${user.hn || '-'}</span>`;
                let classes = 'p-3 rounded-md cursor-pointer hover:bg-indigo-100 transition-colors duration-150';
                
                const loggedInUser = sessionStorage.getItem('loggedInUser');
                const lockOwner = globalState.lockedIds ? globalState.lockedIds[user.id] : null;
                const completedBy = globalState.completedIds ? globalState.completedIds[user.id] : null;

                if (completedBy) {
                    content = `<span class="font-bold block">${user.fullName}</span><span class="text-sm">${user.id}</span><span class="absolute right-3 top-1/2 -translate-y-1/2 text-green-600 font-bold">✔ เสร็จสิ้น</span>`;
                    classes = 'relative p-3 rounded-md text-gray-400 bg-green-50 cursor-not-allowed';
                } else if (lockOwner && lockOwner !== loggedInUser) {
                    content = `<span class="font-bold block">${user.fullName}</span><span class="text-sm">${user.id}</span><span class="absolute right-3 top-1/2 -translate-y-1/2 text-yellow-600 font-bold">กำลังนับ</span>`;
                    classes = 'relative p-3 rounded-md text-gray-400 bg-yellow-50 cursor-not-allowed';
                } else if (activeTimers.some(t => t.user.id === user.id)) {
                    classes = 'p-3 rounded-md text-white bg-blue-500';
                }
                li.innerHTML = content;
                li.className = classes;
                userList.appendChild(li);
            });
            userListContainer.classList.remove('hidden');
        }
        
        async function startProcess(searchId) {
            const record = allUsers.find(user => user.id === searchId || (user.hn && user.hn === searchId));

            if (!record) {
                if(errorSynth) errorSynth.triggerAttackRelease("C3", "8n");
                updateStatusMessage(`ไม่พบข้อมูลสำหรับเลข: ${searchId}`, 'error');
                idInput.classList.add('input-error');
                setTimeout(() => idInput.classList.remove('input-error'), 1000);
                idInput.value = '';
                userListContainer.classList.add('hidden');
                renderUserList('');
                return;
            }

            const primaryId = record.id; // Always use the 13-digit ID as the key
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            const lockOwner = globalState.lockedIds ? globalState.lockedIds[primaryId] : null;
            const completedBy = globalState.completedIds ? globalState.completedIds[primaryId] : null;

            if (completedBy) {
                updateStatusMessage(`'${record.fullName}' ตรวจเสร็จแล้วโดย ${completedBy}`, 'error');
                if(errorSynth) errorSynth.triggerAttackRelease("C3", "8n");
                idInput.value = '';
                return;
            }
            
            if (lockOwner && lockOwner !== loggedInUser) {
                updateStatusMessage(`'${record.fullName}' ถูกนับโดย ${lockOwner} แล้ว`, 'error');
                if(errorSynth) errorSynth.triggerAttackRelease("C3", "8n");
                idInput.value = '';
                return;
            }

            if (activeTimers.some(timer => timer.user.id === primaryId)) {
                updateStatusMessage(`"${record.fullName}" กำลังนับเวลาอยู่แล้ว`, 'info'); 
                idInput.value = '';
                return;
            }

            if(successSynth) successSynth.triggerAttackRelease("C5", "8n");
            
            const globalStateDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'countdownData', 'globalState');
            await setDoc(globalStateDocRef, { lockedIds: { [primaryId]: loggedInUser } }, { merge: true });

            const timerPlaceholderEl = document.getElementById('timerPlaceholder');
            if (timerPlaceholderEl) timerPlaceholderEl.remove();
            const durationInSeconds = sessionDefaultTimeInSeconds !== null ? sessionDefaultTimeInSeconds : parseInt(record.timeInSeconds, 10);
            
            const completionTime = new Date().toISOString();
            const timerData = { user: record, startTime: Date.now(), duration: durationInSeconds * 1000, finished: false, completionTime: completionTime };
            
            activeTimers.push(timerData);
            createTimerCard(record, null, completionTime);
            renderUserList(idInput.value.trim());
            startGlobalAnimationLoop();
            updateStatusMessage(`เริ่มนับเวลาสำหรับ: ${record.fullName}`, 'success');
            saveState();
            
            idInput.value = '';
            userListContainer.classList.add('hidden');
            renderUserList('');
        }
        
        function createTimerCard(user, owner, completionTime) {
            const card = document.createElement('div');
            card.id = `timer-${user.id}`;
            const ownerHtml = owner ? `<p class="text-xs opacity-70 mt-1">โดย: ${owner}</p>` : '';
            card.className = 'timer-card p-4 bg-indigo-500 text-white rounded-lg shadow-md flex justify-between items-center';
            card.innerHTML = `
                <div class="flex-grow">
                    <h3 class="font-bold text-xl">${user.fullName}</h3>
                    <p class="text-sm opacity-80">ID: ${user.id} / HN: ${user.hn || '-'}</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="font-mono text-4xl font-bold tracking-tighter" data-timer-display="true">00:00:00.000</div>
                    ${!owner ? `<div class="result-btn-container w-24 text-center">
                                     <div class="flex flex-col space-y-2">
                                         <button onclick="recordResult('${user.id}', '${completionTime}', 'ผลบวก (+)')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">ผลบวก (+)</button>
                                         <button onclick="recordResult('${user.id}', '${completionTime}', 'ผลลบ (-)')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">ผลลบ (-)</button>
                                     </div>
                                 </div>` : ''}
                    ${!owner ? `<button onclick="cancelTimer('${user.id}')" class="text-white/70 hover:text-white p-2 rounded-full transition-colors self-center">
                                     <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                   </button>` : ''}
                </div>
            `;
            activeTimersContainer.prepend(card);
        }
        
        async function updateGlobalState(updates) {
            const globalStateDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'countdownData', 'globalState');
            await updateDoc(globalStateDocRef, updates);
        }

        function globalAnimationLoop() {
            activeTimers.forEach(timer => {
                const now = Date.now();
                const elapsedTime = now - timer.startTime;
                const timeLeftMs = timer.duration - elapsedTime;
                const card = document.getElementById(`timer-${timer.user.id}`);
                if (!card) return;
                const display = card.querySelector('[data-timer-display]');

                if (timeLeftMs > 0) {
                    updateTimerDisplay(display, timeLeftMs);
                } else {
                    updateTimerDisplay(display, 0);
                    if (!timer.finished) {
                        timer.finished = true;
                        card.classList.remove('bg-indigo-500');
                        card.classList.add('bg-red-600');
                        addToHistory(timer.user, "รอผล", timer.duration, timer.completionTime, true);
                    }
                }
            });
            
            if (activeTimers.length > 0) {
                 globalAnimationFrameId = requestAnimationFrame(globalAnimationLoop);
            } else {
                 cancelAnimationFrame(globalAnimationFrameId);
                 globalAnimationFrameId = null;
            }
        }
        
        window.cancelTimer = async function(userId) {
            const timerIndex = activeTimers.findIndex(t => t.user.id === userId);
            if (timerIndex === -1) return;

            // Remove from active timers
            activeTimers.splice(timerIndex, 1);

            // Remove from UI
            const card = document.getElementById(`timer-${userId}`);
            if (card) card.remove();
            
            // Unlock the ID in global state
            await updateGlobalState({
                [`lockedIds.${userId}`]: deleteField()
            });

            // Save the current user's state (with the timer removed)
            await saveState();

            // Check if we need to show the placeholder
            if (activeTimers.length === 0) {
                if (!document.getElementById('timerPlaceholder')) {
                   activeTimersContainer.innerHTML = '<div id="timerPlaceholder" class="text-center text-gray-400 flex items-center justify-center h-full"><p>ยิงบาร์โค้ดเพื่อเริ่มนับเวลา...</p></div>';
                }
            }
        }

        window.recordResult = async function(userId, completionTime, result) {
            const timerIndex = activeTimers.findIndex(t => t.completionTime === completionTime);
            if (timerIndex === -1) {
                console.warn(`Timer with completionTime ${completionTime} not found for user ${userId}.`);
                return;
            }
    
            const timer = activeTimers[timerIndex];
    
            // Remove the timer from the active list *before* saving the state.
            activeTimers.splice(timerIndex, 1);
            
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            
            // Update the global state to release the lock and mark as completed.
            await updateGlobalState({
                [`lockedIds.${userId}`]: deleteField(),
                [`completedIds.${userId}`]: loggedInUser
            });
    
            // This function will update the history array and then call saveState().
            // saveState() will use the now-updated activeTimers array.
            // The snapshot listener will then automatically handle all UI updates.
            addToHistory(timer.user, result, timer.duration, completionTime, true);
        }

        function startGlobalAnimationLoop() {
            if (!globalAnimationFrameId) {
                globalAnimationFrameId = requestAnimationFrame(globalAnimationLoop);
            }
        }

        function updateTimerDisplay(element, ms) {
            let totalSeconds = Math.floor(ms / 1000);
            let hours = Math.floor(totalSeconds / 3600);
            totalSeconds %= 3600;
            let minutes = Math.floor(totalSeconds / 60);
            let seconds = totalSeconds % 60;
            let milliseconds = Math.floor(ms % 1000);
            element.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
        }

        function renderHistory(isAdminView = false) {
            historyBody.innerHTML = '';
            if (historyData.length === 0) {
                historyBody.innerHTML = `<tr class="bg-white border-b"><td colspan="6" class="px-6 py-4 text-center">ยังไม่มีประวัติ</td></tr>`;
                return;
            }
            historyData.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                const totalSeconds = Math.floor(entry.durationMs / 1000);
                const timeFormatted = new Date(totalSeconds * 1000).toISOString().substr(11, 8);
                const ownerHtml = isAdminView ? `<span class="text-xs text-gray-400">(${entry.owner || 'N/A'})</span>` : '';
                
                let completionTimeFormatted = '-';
                if (entry.completionTime) {
                    completionTimeFormatted = new Date(entry.completionTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                }
                
                let statusHtml = `<span class="bg-gray-100 text-gray-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${entry.status}</span>`;
                if (entry.status === 'ผลบวก (+)' || entry.status === 'ผลลบ (-)') {
                    statusHtml = `<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${entry.status}</span>`;
                } else if (entry.status === 'รอผล') {
                    statusHtml = `<span class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${entry.status}</span>`;
                }


                row.innerHTML = `<td class="px-6 py-4 font-medium text-gray-900">${historyData.length - index}</td><td class="px-6 py-4">${entry.user.fullName} ${ownerHtml}<br><span class="text-xs text-gray-500">ID: ${entry.user.id} / HN: ${entry.user.hn || '-'}</span></td><td class="px-6 py-4">${timeFormatted}</td><td class="px-6 py-4">${completionTimeFormatted}</td><td class="px-6 py-4">${statusHtml}</td><td class="px-6 py-4 text-right">${!isAdminView ? `<button onclick="deleteHistoryItem('${entry.completionTime}')" class="text-red-500 hover:text-red-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>` : ''}</td>`;
                historyBody.appendChild(row);
            });
        }
        
        window.deleteHistoryItem = async function(completionTime) {
            const itemToDelete = historyData.find(item => item.completionTime === completionTime);
            if (itemToDelete) {
                await updateGlobalState({ [`completedIds.${itemToDelete.user.id}`]: deleteField() });
            }
            historyData = historyData.filter(item => item.completionTime !== completionTime);
            saveState();
        }

        function addToHistory(user, status, durationMs, completionTime, isUpdate = false) {
            const existingIndex = historyData.findIndex(item => item.completionTime === completionTime);
            if (isUpdate && existingIndex > -1) { 
                historyData[existingIndex].status = status;
            } else if (existingIndex === -1) { 
                const historyEntry = { user, status, durationMs, completionTime };
                historyData.unshift(historyEntry);
            }
            renderHistory();
            if (sessionStorage.getItem('isAdmin') !== 'true') {
                saveState();
            }
        }

        function updateStatusMessage(message, type = 'info') {
            statusText.textContent = message;
            statusText.classList.remove('text-gray-500', 'text-red-600', 'text-green-600', 'font-bold');
            
            switch (type) {
                case 'error': statusText.classList.add('text-red-600', 'font-bold'); break;
                case 'success': statusText.classList.add('text-green-600'); break;
                default: statusText.classList.add('text-gray-500'); break;
            }

            setTimeout(() => {
                if (statusText.textContent === message) {
                    statusText.textContent = 'กรุณายิงบาร์โค้ดเพื่อเริ่ม';
                    statusText.classList.remove('text-red-600', 'text-green-600', 'font-bold');
                    statusText.classList.add('text-gray-500');
                }
            }, 3000);
        }
        
        async function saveState() {
            // Guard against saving state before the initial data has been loaded from Firestore.
            if (!isInitialLoadComplete) {
                console.warn("Attempted to save state before initial load was complete. Operation skipped.");
                return;
            }
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (!db || !loggedInUser || loggedInUser === 'admin') return;

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'countdownData', loggedInUser);
            
            const timersToSave = activeTimers.map(t => ({ id: t.user.id, endTime: t.startTime + t.duration, duration: t.duration, completionTime: t.completionTime }));
            
            const dataToSave = {
                activeTimers: timersToSave,
                timerHistory: historyData,
            };

            try {
                await setDoc(docRef, dataToSave);
            } catch (error) {
                console.error("Error saving state to Firestore:", error);
            }
        }
        
        function handleLogin() {
            const user = usernameInput.value.trim();
            const pass = passwordInput.value.trim();

            if (USER_CREDENTIALS[user] && USER_CREDENTIALS[user] === pass) {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('loggedInUser', user);
                if (user === 'admin') {
                    sessionStorage.setItem('isAdmin', 'true');
                }
                loginScreen.classList.add('hidden');
                const container = user === 'admin' ? adminContainer : appContainer;
                container.classList.remove('hidden');
                main(); 
            } else {
                loginError.classList.remove('hidden');
                loginScreen.querySelector('div').classList.add('shake');
                setTimeout(() => {
                    loginScreen.querySelector('div').classList.remove('shake');
                }, 500);
            }
        }
        
        function showNotification(title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        }
        
        // --- OCR Functions ---
        async function initializeOCR() {
            if (tesseractWorker) return;
            ocrStatusEl.innerHTML = '<div class="ocr-loader w-5 h-5 border-2 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div><p class="ml-2 text-sm">กำลังเตรียมระบบ OCR...</p>';
            tesseractWorker = await Tesseract.createWorker('eng', 1, {
                logger: m => { 
                    if (m.status === 'recognizing text') {
                        const progress = (m.progress * 100).toFixed(0);
                        ocrStatusEl.innerHTML = `<div class="ocr-loader w-5 h-5 border-2 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div><p class="ml-2 text-sm">กำลังวิเคราะห์... ${progress}%</p>`;
                    }
                }
            });
            console.log("Tesseract worker initialized.");
        }

        async function startOcrCamera() {
            ocrStatusEl.textContent = 'กำลังเปิดกล้อง...';
            let stream;
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                // Attempt to find the ultra-wide camera, common on iOS devices.
                let selectedDevice = videoDevices.find(device => device.label.toLowerCase().includes('ultra wide'));
                const constraints = { video: {} };
                if (selectedDevice) {
                    console.log('Found ultra wide camera:', selectedDevice.label);
                    constraints.video.deviceId = { exact: selectedDevice.deviceId };
                } else {
                    console.log('Ultra wide camera not found, defaulting to environment facingMode.');
                    constraints.video.facingMode = 'environment';
                }
                stream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (err) {
                 console.warn("Could not get preferred camera, falling back.", err);
                 try {
                     // Fallback specifically to the rear camera if the initial attempt fails.
                     stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                 } catch (fallbackErr) {
                     console.error("Error accessing any camera: ", fallbackErr);
                     ocrStatusEl.textContent = 'ข้อผิดพลาด: ไม่สามารถเปิดกล้องได้';
                     return;
                 }
            }
            if (stream) {
                ocrVideo.srcObject = stream;
                ocrVideo.addEventListener('canplay', () => {
                    isOcrCameraReady = true;
                    ocrCaptureBtn.disabled = false;
                    ocrStatusEl.textContent = 'ระบบพร้อมแล้ว';
                });
            }
        }

        function stopOcrCamera() {
            if (ocrVideo.srcObject) {
                ocrVideo.srcObject.getTracks().forEach(track => track.stop());
                ocrVideo.srcObject = null;
                isOcrCameraReady = false;
                ocrCaptureBtn.disabled = true;
            }
        }

        // --- Event Listeners ---
        loginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') handleLogin();
        });
        
        logoutBtn.addEventListener('click', () => {
            sessionStorage.clear();
            window.location.reload();
        });
        adminLogoutBtn.addEventListener('click', () => {
            sessionStorage.clear();
            window.location.reload();
        });

        idInput.addEventListener('focus', () => {
            if (idInput.value.trim()) {
                renderUserList(idInput.value.trim());
            }
        });

        idInput.addEventListener('input', () => {
            const value = idInput.value.trim();
            renderUserList(value);
            if (/^(\d{13}|\d{7})$/.test(value)) {
                startProcess(value);
            }
        });
        
        userList.addEventListener('click', (event) => {
            const li = event.target.closest('li');
            if (li) {
                const isClickable = !li.classList.contains('cursor-not-allowed');
                if (isClickable) {
                    startProcess(li.dataset.id);
                }
            }
        });

        document.addEventListener('click', (event) => {
            const searchContainer = idInput.closest('.relative');
            if (searchContainer && !searchContainer.contains(event.target)) {
                userListContainer.classList.add('hidden');
            }
        });

        setDefaultTimeBtn.addEventListener('click', () => {
            const h = parseInt(hoursInput.value) || 0;
            const m = parseInt(minutesInput.value) || 0;
            const s = parseInt(secondsInput.value) || 0;
            sessionDefaultTimeInSeconds = (h * 3600) + (m * 60) + s;
            updateStatusMessage(`ตั้งค่าเวลาเริ่มต้นเป็น ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`, 'success');
            idInput.focus();
        });

        resetAllBtn.addEventListener('click', () => {
            if (document.getElementById('resetConfirmationDiv')) return;

            const confirmationDiv = document.createElement('div');
            confirmationDiv.id = 'resetConfirmationDiv';
            confirmationDiv.className = 'mt-4 p-4 bg-yellow-100 border border-yellow-300 rounded-lg';
            
            confirmationDiv.innerHTML = `<label for="resetPasswordInput" class="block text-sm font-medium text-gray-700 mb-2">กรุณาใส่รหัส 3215 เพื่อยืนยันการรีเซ็ต</label><input type="password" id="resetPasswordInput" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"><div class="flex gap-2 mt-3"><button id="confirmResetBtn" class="flex-1 bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition">ยืนยัน</button><button id="cancelResetBtn" class="flex-1 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-400 transition">ยกเลิก</button></div>`;
            
            resetAllBtn.parentNode.insertBefore(confirmationDiv, resetAllBtn);
            resetAllBtn.classList.add('hidden');

            const confirmBtn = document.getElementById('confirmResetBtn');
            const cancelBtn = document.getElementById('cancelResetBtn');
            const passwordInput = document.getElementById('resetPasswordInput');
            passwordInput.focus();

            const removeConfirmation = () => {
                confirmationDiv.remove();
                resetAllBtn.classList.remove('hidden');
            };

            confirmBtn.addEventListener('click', async () => {
                if (passwordInput.value === '3215') {
                    const loggedInUser = sessionStorage.getItem('loggedInUser');

                    const globalUpdates = {};
                    
                    activeTimers.forEach(timer => {
                        globalUpdates[`lockedIds.${timer.user.id}`] = deleteField();
                    });
                    
                    if (globalState.completedIds) {
                        historyData.forEach(entry => {
                            if (globalState.completedIds[entry.user.id] === loggedInUser) {
                                globalUpdates[`completedIds.${entry.user.id}`] = deleteField();
                            }
                        });
                    }

                    if (Object.keys(globalUpdates).length > 0) {
                        const globalStateDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'countdownData', 'globalState');
                        try {
                            await updateDoc(globalStateDocRef, globalUpdates);
                        } catch (err) {
                            console.error("Error clearing global states:", err);
                        }
                    }

                    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'countdownData', loggedInUser);
                    try {
                        await setDoc(userDocRef, {});
                    } catch (err) {
                        console.error("Error clearing user document:", err)
                    }
                    
                    removeConfirmation();
                } else {
                    passwordInput.classList.add('input-error');
                    passwordInput.value = '';
                    passwordInput.placeholder = 'รหัสผ่านไม่ถูกต้อง!';
                    setTimeout(() => {
                        passwordInput.classList.remove('input-error');
                        passwordInput.placeholder = '';
                    }, 2000);
                }
            });

            cancelBtn.addEventListener('click', removeConfirmation);
        });
        
        scanBtn.addEventListener('click', () => {
            const readerLoading = document.getElementById('reader-loading');
            
            scannerModal.classList.remove('hidden');
            readerLoading.classList.remove('hidden');
            document.getElementById('reader').innerHTML = '';

            requestAnimationFrame(() => {
                html5Qrcode = new Html5Qrcode("reader", { verbose: false });

                const config = { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 },
                    rememberLastUsedCamera: true
                };

                const onScanSuccess = (decodedText, decodedResult) => {
                    if (/^\d+$/.test(decodedText)) {
                        closeScannerBtn.click(); 
                        startProcess(decodedText);
                    }
                };

                html5Qrcode.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    (errorMessage) => { /* ignore */ }
                )
                .then(() => {
                    readerLoading.classList.add('hidden');
                })
                .catch((err) => {
                    console.error(`Unable to start scanning, error: ${err}`);
                    showNotification('เกิดข้อผิดพลาด', `ไม่สามารถเริ่มการสแกนได้: กรุณาตรวจสอบว่าคุณได้อนุญาตให้เบราว์เซอร์เข้าถึงกล้องแล้ว`);
                    closeScannerBtn.click();
                });
            }); 
        });

        closeScannerBtn.addEventListener('click', async () => {
            if (html5Qrcode && html5Qrcode.isScanning) {
                try {
                    await html5Qrcode.stop();
                    await html5Qrcode.clear();
                } catch (err) {
                    console.error("Error stopping or clearing scanner.", err);
                }
            }
            scannerModal.classList.add('hidden');
            html5Qrcode = null;
        });

        if (masterResetBtn) {
            masterResetBtn.addEventListener('click', () => {
                if (document.getElementById('masterResetConfirmationDiv')) return;

                const confirmationDiv = document.createElement('div');
                confirmationDiv.id = 'masterResetConfirmationDiv';
                confirmationDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                confirmationDiv.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">ยืนยันการรีเซ็ตระบบทั้งหมด</h3>
                        <p class="text-sm text-gray-600 mb-4">การดำเนินการนี้จะล้างสถานะ "กำลังนับ" และ "เสร็จสิ้น" ทั้งหมดของทุกคน แต่จะไม่ลบประวัติการทำงานของผู้ใช้แต่ละคน</p>
                        <label for="masterResetPasswordInput" class="block text-sm font-medium text-gray-700 mb-2">กรุณาใส่รหัส 3215 เพื่อยืนยัน</label>
                        <input type="password" id="masterResetPasswordInput" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <div class="flex gap-2 mt-3">
                            <button id="confirmMasterResetBtn" class="flex-1 bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition">ยืนยัน</button>
                            <button id="cancelMasterResetBtn" class="flex-1 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-400 transition">ยกเลิก</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(confirmationDiv);

                const confirmBtn = document.getElementById('confirmMasterResetBtn');
                const cancelBtn = document.getElementById('cancelMasterResetBtn');
                const passwordInput = document.getElementById('masterResetPasswordInput');
                passwordInput.focus();

                const removeConfirmation = () => {
                    confirmationDiv.remove();
                };

                confirmBtn.addEventListener('click', async () => {
                    if (passwordInput.value === '3215') {
                        try {
                            const globalStateDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'countdownData', 'globalState');
                            await setDoc(globalStateDocRef, {}); // This clears lockedIds and completedIds
                            showNotification('สำเร็จ', 'ระบบได้รีเซ็ตสถานะทั้งหมดเรียบร้อยแล้ว');
                        } catch (err) {
                            console.error("Error performing master reset:", err);
                            showNotification('ข้อผิดพลาด', 'ไม่สามารถรีเซ็ตระบบได้');
                        } finally {
                            removeConfirmation();
                        }
                    } else {
                        passwordInput.classList.add('input-error');
                        passwordInput.value = '';
                        passwordInput.placeholder = 'รหัสผ่านไม่ถูกต้อง!';
                        setTimeout(() => {
                            passwordInput.classList.remove('input-error');
                            passwordInput.placeholder = '';
                        }, 2000);
                    }
                });

                cancelBtn.addEventListener('click', removeConfirmation);
            });
        }

        downloadExcelBtn.addEventListener('click', () => {
            let combinedHistory = [];
            for (const username in userSnapshots) {
                const data = userSnapshots[username];
                if (data.timerHistory) {
                    combinedHistory.push(...data.timerHistory.map(item => ({...item, owner: username})));
                }
            }

            if (combinedHistory.length === 0) {
                showNotification("ไม่มีข้อมูล", "ไม่มีข้อมูลประวัติให้ดาวน์โหลด");
                return;
            }
            
            combinedHistory.sort((a, b) => new Date(b.completionTime) - new Date(a.completionTime));

            const headers = ["ผู้ใช้งาน", "ID", "HN", "ชื่อ-สกุล", "เวลาที่ตั้งค่า (HH:MM:SS)", "เวลาที่ครบกำหนด", "ผลการตรวจ"];
            let csvContent = "\uFEFF" + headers.join(",") + "\n";

            combinedHistory.forEach(entry => {
                const user = entry.user;
                const owner = entry.owner || 'N/A';
                const id = `'${user.id}`; // Add apostrophe to treat as text in excel
                const hn = `'${user.hn || ''}`;
                const fullName = user.fullName.replace(/,/g, ''); 
                const durationSeconds = Math.floor(entry.durationMs / 1000);
                const setTime = new Date(durationSeconds * 1000).toISOString().substr(11, 8);
                const completionTime = entry.completionTime ? new Date(entry.completionTime).toLocaleTimeString('th-TH') : '-';
                const status = entry.status || 'N/A';

                const row = [owner, id, hn, fullName, setTime, completionTime, status].join(",");
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                const date = new Date().toISOString().slice(0, 10);
                link.setAttribute("href", url);
                link.setAttribute("download", `ประวัติการนับเวลา_${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
        
        notificationCloseBtn.addEventListener('click', () => {
            notificationModal.classList.add('hidden');
        });

        // --- OCR Event Listeners ---
        ocrScanBtn.addEventListener('click', () => {
            ocrScannerModal.classList.remove('hidden');
            ocrCaptureBtn.disabled = true;
            isOcrCameraReady = false;
            startOcrCamera();
        });

        closeOcrScannerBtn.addEventListener('click', () => {
            stopOcrCamera();
            ocrScannerModal.classList.add('hidden');
        });

        ocrCaptureBtn.addEventListener('click', async () => {
            if (!isOcrCameraReady || !tesseractWorker) return;

            ocrCaptureBtn.disabled = true;
            
            const canvas = document.createElement('canvas');
            const scanBox = document.getElementById('ocr-scan-box');
            const context = canvas.getContext('2d');
            const videoRect = ocrVideo.getBoundingClientRect();
            const scanBoxRect = scanBox.getBoundingClientRect();

            const scaleX = ocrVideo.videoWidth / videoRect.width;
            const scaleY = ocrVideo.videoHeight / videoRect.height;

            const cropX = (scanBoxRect.left - videoRect.left) * scaleX;
            const cropY = (scanBoxRect.top - videoRect.top) * scaleY;
            const cropWidth = scanBoxRect.width * scaleX;
            const cropHeight = scanBoxRect.height * scaleY;

            canvas.width = cropWidth;
            canvas.height = cropHeight;
            context.drawImage(ocrVideo, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
            
            try {
                const { data: { text } } = await tesseractWorker.recognize(canvas);
                const numberSequences = text.match(/\d+/g) || [];
                if (numberSequences.length > 0) {
                    const longestNumber = numberSequences.reduce((a, b) => a.length > b.length ? a : b);
                    if (longestNumber.length === 13 || longestNumber.length === 7) {
                        // Check if the user exists in our data
                        const record = allUsers.find(user => user.id === longestNumber || (user.hn && user.hn === longestNumber));

                        if (record) {
                            // User found: close scanner and start the timer process
                            closeOcrScannerBtn.click();
                            startProcess(record.id); // Always start process with the primary ID
                        } else {
                            // User not found: show error message within the OCR modal
                            if(errorSynth) errorSynth.triggerAttackRelease("C3", "8n");
                            ocrStatusEl.innerHTML = `<p class="text-red-500 font-bold">ไม่พบข้อมูลสำหรับเลข: ${longestNumber}</p>`;
                            // Reset status message after a delay
                            setTimeout(() => {
                                if (ocrStatusEl.innerHTML.includes(longestNumber)) {
                                    ocrStatusEl.innerHTML = '<p>ระบบพร้อมแล้ว</p>';
                                }
                            }, 3000);
                        }
                    } else {
                       ocrStatusEl.textContent = 'ไม่พบตัวเลขที่ชัดเจน';
                    }
                } else {
                     ocrStatusEl.textContent = 'ไม่พบตัวเลข';
                }
            } catch (error) {
                console.error('OCR Error:', error);
                ocrStatusEl.textContent = 'เกิดข้อผิดพลาด';
            } finally {
                ocrCaptureBtn.disabled = false; // Re-enable button for another try
            }
        });

    </script>
</body>
</html>
